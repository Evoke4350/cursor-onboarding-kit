name: Release Package

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve version
        id: meta
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          {
            echo "tag=${TAG}"
            echo "version=${VERSION}"
          } >> "$GITHUB_OUTPUT"

      - name: Build full package zip
        run: |
          mkdir -p dist
          git archive \
            --format=zip \
            --output "dist/ai-engineering-workflow-jumpstart-kit-${{ steps.meta.outputs.tag }}.zip" \
            HEAD

      - name: Build docs-only zip
        run: |
          mkdir -p dist/docs
          rsync -a --prune-empty-dirs \
            --include='*/' \
            --include='*.md' \
            --exclude='*' \
            ./ dist/docs/
          (
            cd dist
            zip -rq "ai-engineering-workflow-jumpstart-docs-${{ steps.meta.outputs.tag }}.zip" docs
          )
          rm -rf dist/docs

      - name: Generate checksums
        run: |
          (
            cd dist
            shasum -a 256 -- ./*.zip > SHA256SUMS.txt
          )

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/*.zip
            dist/SHA256SUMS.txt
