name: Branch Release Package

on:
  push:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      semver:
        description: "Override semver (X.Y.Z). Defaults to VERSION file."
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: branch-release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          INPUT_SEMVER="${{ github.event.inputs.semver || '' }}"
          if [[ -n "${INPUT_SEMVER}" ]]; then
            RAW_VERSION="${INPUT_SEMVER}"
          elif [[ -f VERSION ]]; then
            RAW_VERSION="$(tr -d '[:space:]' < VERSION)"
          else
            echo "ERROR: VERSION file not found and semver input was empty." >&2
            exit 1
          fi

          SEMVER="${RAW_VERSION#v}"
          if ! [[ "${SEMVER}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: invalid semver '${RAW_VERSION}'. Expected X.Y.Z." >&2
            exit 1
          fi

          BRANCH="${GITHUB_REF_NAME}"
          BRANCH_SLUG="$(echo "${BRANCH}" | tr '[:upper:]' '[:lower:]' | sed -E 's#[^a-z0-9]+#-#g; s#(^-|-$)##g')"
          TAG="branch-${BRANCH_SLUG}-v${SEMVER}"

          echo "semver=${SEMVER}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "branch_slug=${BRANCH_SLUG}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "release_name=v${SEMVER} (${BRANCH})" >> "$GITHUB_OUTPUT"

      - name: Upsert branch tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.meta.outputs.tag }}"
          git tag -f "${TAG}" "${GITHUB_SHA}"
          git push origin "refs/tags/${TAG}" --force

      - name: Build full package zip
        run: |
          mkdir -p dist
          git archive \
            --format=zip \
            --output "dist/ai-engineering-workflow-jumpstart-kit-v${{ steps.meta.outputs.semver }}-${{ steps.meta.outputs.branch_slug }}.zip" \
            HEAD

      - name: Build docs-only zip
        run: |
          mkdir -p dist/docs
          rsync -a --prune-empty-dirs \
            --include='*/' \
            --include='*.md' \
            --exclude='*' \
            ./ dist/docs/
          (
            cd dist
            zip -rq "ai-engineering-workflow-jumpstart-docs-v${{ steps.meta.outputs.semver }}-${{ steps.meta.outputs.branch_slug }}.zip" docs
          )
          rm -rf dist/docs

      - name: Generate checksums
        run: |
          (
            cd dist
            shasum -a 256 *.zip > SHA256SUMS.txt
          )

      - name: Publish branch release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: ${{ steps.meta.outputs.release_name }}
          prerelease: true
          make_latest: false
          overwrite_files: true
          generate_release_notes: true
          files: |
            dist/*.zip
            dist/SHA256SUMS.txt
